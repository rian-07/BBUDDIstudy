import { auth } from '/BBUDDIstudy/js/firebase-init.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const db = getFirestore();
const recordListEl = document.getElementById('record-list');
const saveBtn = document.getElementById('save-record-btn');

let records = []; // {id, subject, duration, note}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = '/BBUDDIstudy/index.html';
    return;
  }

  await loadRecords(user.uid);
  renderRecords();
});

async function loadRecords(uid) {
  records = [];
  const colRef = collection(db, 'users', uid, 'studyRecords');
  const snapshot = await getDocs(colRef);
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    records.push({
      id: docSnap.id,
      subject: data.subject || '',
      duration: data.duration || '',
      note: data.note || ''
    });
  });
}

function renderRecords() {
  recordListEl.innerHTML = '';
  records.forEach((record, idx) => {
    const li = document.createElement('li');

    li.innerHTML = `
      <input type="text" class="record-input subject" placeholder="과목" value="${record.subject}" data-idx="${idx}" />
      <input type="text" class="record-input duration" placeholder="시간 (예: 01:00:00)" value="${record.duration}" data-idx="${idx}" />
      <input type="text" class="record-input note" placeholder="메모" value="${record.note}" data-idx="${idx}" />
    `;

    recordListEl.appendChild(li);
  });
}

saveBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return alert('로그인 상태가 아닙니다.');

  const inputs = recordListEl.querySelectorAll('input.record-input');
  inputs.forEach(input => {
    const idx = input.dataset.idx;
    const className = input.classList.contains('subject') ? 'subject'
                    : input.classList.contains('duration') ? 'duration'
                    : 'note';
    records[idx][className] = input.value.trim();
  });

  const savePromises = records.map(record => {
    const docRef = doc(db, 'users', user.uid, 'studyRecords', record.id);
    return setDoc(docRef, {
      subject: record.subject,
      duration: record.duration,
      note: record.note
    });
  });

  await Promise.all(savePromises);
  alert('기록이 수정되었습니다!');
  window.location.href = '/BBUDDIstudy/home.html';
});
